name: Terraform Comment Plan

on:
  # Pull Requestã®ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼
  issue_comment:
    types:
      - created

jobs:
  # ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹Planå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  comment_plan:
    name: Plan on Comment
    runs-on: ubuntu-latest
    # ã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ã§ã€ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ãŒ"plan"ã‚’å«ã¿ã€ãã‚ŒãŒPRã«å¯¾ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®å ´åˆã«å®Ÿè¡Œ
    if: contains(github.event.comment.body, 'plan') && github.event.issue.pull_request
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.issue.pull_request.head.ref }} # PRã®HEADã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          repository: ${{ github.event.issue.pull_request.head.repo.full_name }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      # Terraform Init ã¨ Plan ã‚’å®Ÿè¡Œ
      - name: Run Terraform Init and Plan
        id: tf_steps
        working-directory: ./envs/dev/souvenirConsultApp/
        run: |
          terraform init -backend=true -reconfigure || true
          # Plançµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ (-no-color ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ )
          # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã« || true ã‚’è¿½åŠ 
          terraform plan -no-color > plan_output.txt || true
          
          # Plançµæœãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç’°å¢ƒå¤‰æ•°ã«æ ¼ç´
          if [ -f plan_output.txt ]; then
            PLAN_CONTENT=$(cat plan_output.txt)
            # ã‚­ãƒ£ãƒªã‚¢ãƒªã‚¿ãƒ¼ãƒ³ã‚’LFã«å¤‰æ›
            PLAN_CONTENT=$(echo "$PLAN_CONTENT" | tr -d '\r') 
            echo "PLAN<<EOF" >> $GITHUB_ENV
            echo "$PLAN_CONTENT" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      # Plançµæœã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã«æŠ•ç¨¿ãƒ»æ›´æ–°
      - name: Add Terraform Plan comment to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Plançµæœã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
            const planOutput = process.env.PLAN || ''; // ç’°å¢ƒå¤‰æ•° PLAN ã‹ã‚‰å–å¾—ã€å­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºæ–‡å­—åˆ—
            
            // Planã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ±ºå®š
            let planSectionContent = '';
            // terraform plan -no-color ã®å‡ºåŠ›ã« "No changes." ãŒå«ã¾ã‚Œã‚‹ã‹ç¢ºèª
            if (planOutput.includes('No changes. Your infrastructure matches the configuration.')) {
                planSectionContent = `No changes. Your infrastructure matches the configuration.`;
            } else if (planOutput) {
                // PlançµæœãŒã‚ã‚‹å ´åˆã€diffå½¢å¼ã§è¡¨ç¤º (è‰²ä»˜ãã¯GitHubã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ä¾å­˜)
                // Planå‡ºåŠ›è‡ªä½“ã®æœ«å°¾ã«ä¸è¦ãªæ”¹è¡ŒãŒãªã„ã“ã¨ã‚’æƒ³å®š
                planSectionContent = `\`\`\`diff\n${planOutput}\n\`\`\``;
            } else {
                // Planå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œãªã‹ã£ãŸå ´åˆ (ä¾‹: Planå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ãªã©)
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ã‚‚å«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€Planå‡ºåŠ›ã‚’ãã®ã¾ã¾è¡¨ç¤º
                planSectionContent = `Could not generate plan output or an error occurred. Please check the job logs for details.\n\n${planOutput}`;
            }
            
            // æ—¢å­˜ã®ãƒœãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            // ã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ç”¨ã®æ–°ã—ã„è­˜åˆ¥å­ã‚’è¨­å®šã—ã¾ã™
            const commentIdentifier = '### Terraform Plan Result (Triggered by Comment)';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            // è‡ªèº«ã®ãƒœãƒƒãƒˆãŒæŠ•ç¨¿ã—ãŸã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®çµæœã‚’ç¤ºã™ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes(commentIdentifier);
            });
            
            // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®ç”Ÿæˆ - æ”¹è¡Œã¨ç©ºè¡Œã‚’å³å¯†ã«èª¿æ•´
            const output = `${commentIdentifier}

              #### Terraform Format and Style ğŸ–Œ\`N/A\`
            
              #### Terraform Initialization âš™ï¸\`${{ steps.tf_steps.outcome || 'failure' }}\`
            
              #### Terraform Validation ğŸ¤–\`N/A\`
            
                <details><summary>Validation Output</summary>
            
                \`\`\`terraform
                N/A
                \`\`\`
            
                </details>
            
                #### Terraform Plan ğŸ“–\`${{ steps.tf_steps.outcome || 'failure' }}\`
            
                <details><summary>Show Plan</summary>
            
                ${planSectionContent}
            
                </details>
            
              _Triggered by comment: @${{ github.actor }}_
              _Working Directory: \`./envs/dev/souvenirConsultApp/\`_
                `;
            
                // ã‚³ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã¾ãŸã¯ä½œæˆ
                if (botComment) {
                await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: output
              });
              } else {
                await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
              });
              }