name: Terraform Push Plan

on:
  # Pull Requestã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒ»åŒæœŸãƒ»ãƒªã‚ªãƒ¼ãƒ—ãƒ³æ™‚ã«ãƒˆãƒªã‚¬ãƒ¼
  pull_request:
    branches:
      - master # å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã‚’é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„
    types:
      - opened
      - synchronize
      - reopened

jobs:
  # Pull Requestã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒ»åŒæœŸãƒ»ãƒªã‚ªãƒ¼ãƒ—ãƒ³æ™‚ã®Planå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  pull_request_plan:
    name: Plan on PR
    runs-on: ubuntu-latest
    # PRã‚ªãƒ¼ãƒ—ãƒ³ãƒ»åŒæœŸãƒ»ãƒªã‚ªãƒ¼ãƒ—ãƒ³æ™‚ã«å®Ÿè¡Œ
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦
      contents: read # ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      # .tfãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœ (outputs.tf_changed) ã‚’å¾Œç¶šã§åˆ©ç”¨ã—ã¾ã™
      - name: Check for .tf file changes
        id: check_files
        uses: dorny/paths-filter@v3
        with:
          filters: |
            tf_changed:
              - '**/*.tf'
              - '.terraform.lock.hcl' # ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¯¾è±¡ã«å«ã‚ã‚‹

      # Terraform fmt, init, validate, plan ã‚’å®Ÿè¡Œ
      # .tfãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
      - name: Run Terraform Checks and Plan
        id: tf_steps # å„ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’ã¾ã¨ã‚ã¦å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        if: steps.check_files.outputs.tf_changed == 'true' # å·®åˆ†ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        working-directory: ./envs/dev/souvenirConsultApp/ # Terraformã®ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
        run: |
          # fmt, init, validate ã¯å¤±æ•—ã—ã¦ã‚‚ Plan ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã« || true ã‚’è¿½åŠ 
          # çµæœã¯ã‚¹ãƒ†ãƒƒãƒ—ã® outcomes ã§åˆ¤å®šã—ã¾ã™
          terraform fmt -check -diff || true
          terraform init -backend=true -reconfigure
          terraform validate || true
          
          # Plançµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ (-no-color ã¯ä¸è¦ã€diffå½¢å¼ã§æ•´å½¢ã™ã‚‹ãŸã‚)
          # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã« || true ã‚’è¿½åŠ 
          terraform plan > plan_output.txt || true
          
          # Plançµæœãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç’°å¢ƒå¤‰æ•°ã«æ ¼ç´
          if [ -f plan_output.txt ]; then
            PLAN_CONTENT=$(cat plan_output.txt)
            # ç’°å¢ƒå¤‰æ•°ã«è¤‡æ•°è¡Œã®æ–‡å­—åˆ—ã‚’è¨­å®š
            echo "PLAN<<EOF" >> $GITHUB_ENV
            echo "$PLAN_CONTENT" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      # PRã‚³ãƒ¡ãƒ³ãƒˆã«çµæœã‚’æŠ•ç¨¿ãƒ»æ›´æ–°
      # .tfãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ãŒã‚ã‚‹/ãªã„ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
      - name: Add Terraform Checks and Plan comment to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' # PRã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿å®Ÿè¡Œ
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // tf_changed ã®çµæœã‚’å–å¾—
            const tfChanged = `${{ steps.check_files.outputs.tf_changed }}` === 'true';
            
            // Plançµæœã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
            const planOutput = process.env.PLAN || ''; // ç’°å¢ƒå¤‰æ•° PLAN ã‹ã‚‰å–å¾—ã€å­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºæ–‡å­—åˆ—
            
            // Planã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ±ºå®š
            let planSectionContent = '';
            if (!tfChanged) {
                // .tf ãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ãŒãªã„å ´åˆ
                planSectionContent = `\nNo changes detected in \`.tf\` files.\n`;
            } else if (planOutput.includes('No changes. Your infrastructure matches the configuration.')) {
                // plan å®Ÿè¡ŒçµæœãŒã€ŒNo changesã€ã ã£ãŸå ´åˆ
                planSectionContent = `\nNo changes. Your infrastructure matches the configuration.\n`;
            } else if (planOutput) {
                // PlançµæœãŒã‚ã‚‹å ´åˆã€diffå½¢å¼ã§è¡¨ç¤º (è‰²ä»˜ãã¯GitHubã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ä¾å­˜)
                planSectionContent = `\n\`\`\`diff\n${planOutput}\n\`\`\`\n`;
            } else {
                // Planå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œãªã‹ã£ãŸå ´åˆ (ä¾‹: Planå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ãªã©)
                planSectionContent = `\nCould not generate plan output. Please check the job logs for details.\n`;
            }
            
            // æ—¢å­˜ã®ãƒœãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            // ã‚³ãƒ¡ãƒ³ãƒˆã®è­˜åˆ¥ã®ãŸã‚ã«ã€ç‰¹å®šã®æ–‡å­—åˆ— (ä¾‹: ### Terraform Summary) ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã‚’æ¨å¥¨
            const commentIdentifier = '### Terraform Workflow Results';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            // è‡ªèº«ã®ãƒœãƒƒãƒˆãŒæŠ•ç¨¿ã—ãŸã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®çµæœã‚’ç¤ºã™ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes(commentIdentifier);
            });
            
            // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®ç”Ÿæˆ (ã‚­ãƒ£ãƒ—ãƒãƒ£ã®å½¢å¼ã‚’æ¨¡å€£)
            const output = `${commentIdentifier}
            
            #### Terraform Format and Style ğŸ–Œ\`${{ steps.tf_steps.outcome || 'skipped' }}\`
            #### Terraform Initialization âš™ï¸\`${{ steps.tf_steps.outcome || 'skipped' }}\`
            #### Terraform Validation ğŸ¤–\`${{ steps.tf_steps.outcome || 'skipped' }}\`
            <details><summary>Validation Output</summary>
            
            \`\`\`terraform
            ${{ steps.tf_steps.outputs.stdout || 'N/A' }}
            \`\`\`
            
            </details>
            
            #### Terraform Plan ğŸ“–\`${{ steps.tf_steps.outcome || 'skipped' }}\` <details><summary>Show Plan</summary>
            
            ${planSectionContent} </details>
            
            _Pusher: @${{ github.actor }}, Working Directory: \`./envs/dev/souvenirConsultApp/\`_
            `;
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã¾ãŸã¯ä½œæˆ
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              });
            }

#      # å·®åˆ†ãŒãªã„å ´åˆã«ã®ã¿ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã¯ä¸è¦ã«ãªã£ãŸãŸã‚å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
#      - name: Add No changes comment to PR
#        if: steps.check_files.outputs.tf_changed == 'false'
#        uses: actions/github-script@v7
#        with:
#          github-token: ${{ secrets.GITHUB_TOKEN }}
#          script: |
#            // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚‚ã†å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“