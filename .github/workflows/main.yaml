# .github/workflows/main.yaml

name: "Terraform CI/CD Workflow" # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å

# â˜…ä¿®æ­£â˜… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
on:
  pull_request: # Pull Request ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒˆãƒªã‚¬ãƒ¼
    types: [opened, reopened, synchronize] # PRã‚ªãƒ¼ãƒ—ãƒ³ã€å†ã‚ªãƒ¼ãƒ—ãƒ³ã€æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ
    branches:
      - master # PRã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒãŒ master ã®å ´åˆã®ã¿å®Ÿè¡Œ

    # å¿…è¦ã«å¿œã˜ã¦ã€ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹pathsãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚è¿½åŠ ã§ãã¾ã™ã€‚
    # ä¾‹: ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ä»»æ„ã®.tfãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ãƒˆãƒªã‚¬ãƒ¼
    # paths:
    #   - "**/*.tf"

# ã‚¸ãƒ§ãƒ–ãŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸­ã«æŒã¤æ¨©é™ã‚’è¨­å®š
# comments: write ã¯PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
# contents: read ã¯ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
# pull-requests: write ã¯PRã®çŠ¶æ…‹ã‚’èª­ã¿å–ã‚‹ãŸã‚ã«å¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
# issues: write ã¯ã‚³ãƒ¡ãƒ³ãƒˆã«é–¢é€£ã™ã‚‹å ´åˆã«å¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
permissions:
  contents: read # ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã«å¿…è¦
  pull-requests: write # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦
  issues: write # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦ (pull-requests write ã¨åˆã‚ã›ã¦ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¿…è¦ãªå ´åˆã‚ã‚Š)

jobs:
  terraform-checks: # ã‚¸ãƒ§ãƒ–åã‚’åˆ†ã‹ã‚Šã‚„ã™ãå¤‰æ›´ (ä¾‹: terraform-checks)
    name: 'Terraform Checks for ${{ matrix.directory }}' # matrixã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’ã‚¸ãƒ§ãƒ–åã«å«ã‚ã‚‹
    runs-on: ubuntu-latest # å®Ÿè¡Œç’°å¢ƒ

    strategy:
      matrix:
        # Terraformã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚
        # 'environments/dev' ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®Terraformã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
        directory: ['environments/dev'] # ã”æç¤ºã®matrixè¨­å®šã‚’ãã®ã¾ã¾ä½¿ç”¨
        # ä¾‹: ä»–ã®ç’°å¢ƒã‚‚è¿½åŠ ã™ã‚‹å ´åˆ
        # directory: ['environments/dev', 'environments/stg', 'environments/prod']

      # matrixã‚¸ãƒ§ãƒ–å…¨ä½“ã®è¨­å®š (ç‰¹å®šã®matrixã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã®ã‚¸ãƒ§ãƒ–ã‚’ç¶šè¡Œã™ã‚‹ã‹ãªã©)
      fail-fast: false # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯trueã€‚falseã«ã™ã‚‹ã¨ã€ã‚ã‚‹matrixã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã®ã‚¸ãƒ§ãƒ–ã¯ç¶šè¡Œã€‚

    defaults:
      run:
        # ã“ã®ã‚¸ãƒ§ãƒ–å†…ã®å…¨ã¦ã® run ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ã“ã“ã§æŒ‡å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
        working-directory: ${{ matrix.directory }} # matrixã§æŒ‡å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã™ã‚‹

    steps:
      # -- ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ --
      # â˜…æ›´æ–°â˜… checkout ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–° (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æ©Ÿèƒ½å‘ä¸Š)
      - name: Checkout repository
        uses: actions/checkout@v4

      # -- Terraformã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— --
      # â˜…æ›´æ–°â˜… setup-terraform ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          # å¿…è¦ã«å¿œã˜ã¦ã€Terraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
          terraform_version: latest # æœ€æ–°ç‰ˆã‚’ä½¿ç”¨

      # -- AWSèªè¨¼æƒ…å ±ã®è¨­å®š --
      # â˜…æ›´æ–°â˜… configure-aws-credentials ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–° (v1ã¯éæ¨å¥¨)
      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # GitHub Secretsã«ç™»éŒ²ã•ã‚ŒãŸAWSèªè¨¼æƒ…å ±ã‚’ä½¿ç”¨
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š (ä¾‹: æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³)
          aws-region: ap-northeast-1
          # å¿…è¦ã«å¿œã˜ã¦ã€IAMãƒ­ãƒ¼ãƒ«ã®å¼•ãå—ã‘è¨­å®šãªã©ã‚’è¿½åŠ  (ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢)
          # role-to-assume: arn:aws:iam::YOUR_AWS_ACCOUNT_ID:role/YourGitHubActionsRole
          # web-identity-token-file: ${{ runner.temp }}/token # OIDCé€£æºã®å ´åˆ
          # role-duration-seconds: 900

      # -- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯ --
      # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«Terraformã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
      - name: Check if directory is not empty
        id: check_dir # IDã‚’è¿½åŠ 
        # run ã‚¹ãƒ†ãƒƒãƒ—ã®working-directoryã¯defaultsã§æŒ‡å®šæ¸ˆ
        run: |
          # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã€å‡ºåŠ›ãŒç©ºã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if [ "$(ls -A .)" ]; then
            echo "Directory is not empty. Proceeding with Terraform checks."
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ãªã„ã“ã¨ã‚’ç¤ºã™å‡ºåŠ›å¤‰æ•°ã‚’è¨­å®š (å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã®æ¡ä»¶ã«ä½¿ç”¨å¯èƒ½)
            # echo "directory_not_empty=true" >> "$GITHUB_OUTPUT" # å¿…è¦ã§ã‚ã‚Œã°
          else
            echo "Directory '${{ matrix.directory }}' is empty. Skipping Terraform checks for this directory."
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã®å ´åˆã€ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹ (matrixæˆ¦ç•¥ã¨fail-fast=false ã®çµ„ã¿åˆã‚ã›ã§ä»–ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã¯ç¶šè¡Œ)
            exit 1
          fi
        shell: bash # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã«bashã‚’ä½¿ç”¨

      # -- Terraform Format Check --
      # ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒè¦ç´„ã«å¾“ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      - name: Terraform Format
        id: fmt # IDã‚’è¿½åŠ 
        # run ã‚¹ãƒ†ãƒƒãƒ—ã®working-directoryã¯defaultsã§æŒ‡å®šæ¸ˆ
        # å¿…è¦ã«å¿œã˜ã¦ã€å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ¡ä»¶ã‚’è¿½åŠ ã§ãã¾ã™
        # if: steps.check_dir.conclusion == 'success' # ä¾‹: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ãªã„å ´åˆã®ã¿å®Ÿè¡Œ
        run: terraform fmt -check # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°éã‚¼ãƒ­çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã—ã€ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ã¾ã™

      # -- Terraform Init --
      # Terraformãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
      - name: Terraform Init
        id: init # IDã‚’è¿½åŠ 
        # run ã‚¹ãƒ†ãƒƒãƒ—ã®working-directoryã¯defaultsã§æŒ‡å®šæ¸ˆ
        # å¿…è¦ã«å¿œã˜ã¦ã€å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ¡ä»¶ã‚’è¿½åŠ ã§ãã¾ã™
        # if: steps.check_dir.conclusion == 'success' # ä¾‹: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã§ãªã„å ´åˆã®ã¿å®Ÿè¡Œ
        run: terraform init # Stateãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šã¯versions.tfã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

      # -- Terraform Validate --
      # Terraformã‚³ãƒ¼ãƒ‰ã®æ§‹æ–‡ã¨æ§‹æˆãŒæ­£ã—ã„ã‹æ¤œè¨¼ã—ã¾ã™ã€‚
      - name: Terraform Validate
        id: validate # IDã‚’è¿½åŠ 
        # run ã‚¹ãƒ†ãƒƒãƒ—ã®working-directoryã¯defaultsã§æŒ‡å®šæ¸ˆ
        # å¿…è¦ã«å¿œã˜ã¦ã€å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ¡ä»¶ã‚’è¿½åŠ ã§ãã¾ã™
        # if: steps.init.conclusion == 'success' # ä¾‹: InitãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        run: terraform validate -no-color # ã‚«ãƒ©ãƒ¼å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–

      # -- Terraform Plan --
      # ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã«åŠ ãˆã‚‰ã‚Œã‚‹å¤‰æ›´ã®å®Ÿè¡Œè¨ˆç”»ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
      - name: Terraform Plan
        id: plan # IDã‚’è¿½åŠ 
        # run ã‚¹ãƒ†ãƒƒãƒ—ã®working-directoryã¯defaultsã§æŒ‡å®šæ¸ˆ
        # å¿…è¦ã«å¿œã˜ã¦ã€å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹æ¡ä»¶ã‚’è¿½åŠ ã§ãã¾ã™
        # if: steps.validate.conclusion == 'success' # ä¾‹: ValidateãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        run: terraform plan -no-color # ã‚«ãƒ©ãƒ¼å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–
        # PlanãŒå¤±æ•—ã—ã¦ã‚‚å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãªã©ï¼‰ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã¯ true ã«è¨­å®š
        continue-on-error: true # ã”æç¤ºã®è¨­å®šã‚’ç¶­æŒ

      # -- Plançµæœã‚’æ•´å½¢ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ --
      # Planã®çµæœã‚’Pull Requestã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã—ã¾ã™ã€‚
      # â˜…æ›´æ–°â˜… github-script ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–° (v3ã¯éæ¨å¥¨)
      - name: Comment PR
        # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯Pull Requestã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿å®Ÿè¡Œ
        if: github.event_name == 'pull_request' && steps.plan.conclusion != 'skipped' # â˜…ä¿®æ­£â˜… ifæ¡ä»¶ã‚’ã“ã®ä¸€è¡Œã«ã¾ã¨ã‚ã‚‹
        uses: actions/github-script@v7
        with:
          # GitHubæä¾›ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ (permissionsè¨­å®šã§é©åˆ‡ãªæ¨©é™ãŒå¿…è¦ã§ã™)
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: | # Node.js ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

            // Plançµæœã‚’å–å¾—ã€‚æˆåŠŸæ™‚ã¯ stdout, å¤±æ•—æ™‚ã¯ stderr ã‚’ä½¿ç”¨ã€‚
            // steps.<step_id>.outcome ã¯ 'success', 'failure', 'skipped', 'cancelled'
            const planOutput = `${{ steps.plan.conclusion == 'success' && steps.plan.outputs.stdout || steps.plan.outputs.stderr }}`;

            // 2. Prepare format of the comment
            // å„ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚„Plançµæœã‚’æ•´å½¢ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆã—ã¾ã™ã€‚
            const output = `#### Terraform checks for \`${{ matrix.directory }}\`

              #### Terraform Format ğŸ–Œ\`${{ steps.fmt.conclusion }}\`
              #### Terraform Initialization âš™ï¸\`${{ steps.init.conclusion }}\`
              #### Terraform Validate ğŸ¤–\`${{ steps.validate.conclusion }}\`

              <details><summary>Validation Output</summary>

              \`\`\`terraform
              ${{ steps.validate.outputs.stdout }} // Validate ã®æ¨™æº–å‡ºåŠ› (å¤±æ•—æ™‚ã¯ stderr ã®å ´åˆã‚ã‚Š)
              \`\`\`

              </details>

              #### Terraform Plan ğŸ“–\`${{ steps.plan.conclusion }}\`

              <details><summary>Show Plan</summary>

              \`\`\`diff
              ${planOutput} // Planã®çµæœ (stdout ã¾ãŸã¯ stderr)
              \`\`\`

              </details>

              *Workflow triggered by @${{ github.actor }} in directory \`${{ matrix.directory }}\`*
              `; // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®æœ«å°¾

            // 3. Post or Update Comment
            // GitHub Actions BotãŒéå»ã«æŠ•ç¨¿ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã—ã€ã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆã—ã¾ã™ã€‚
            // ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã«ç‰¹å®šã®è­˜åˆ¥å­ã‚’å«ã‚ã‚‹ã¨ã€ãƒœãƒƒãƒˆã®ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨åŒºåˆ¥ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚
            // ä¾‹: const commentIdentifier = '';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // ç‰¹å®šã®è­˜åˆ¥å­ã‚’å«ã‚€ãƒœãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ (å¿…è¦ã«å¿œã˜ã¦ commentIdentifier ã‚’å®šç¾©)
            const botComment = comments.find(comment => {
               // ç¾åœ¨ã¯ãƒœãƒƒãƒˆã‹ã¤ã€ç‰¹å®šã®æ–‡å­—åˆ—ï¼ˆä¾‹ï¼š'#### Terraform checks for'ï¼‰ã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
              return comment.user.type === 'Bot' && comment.body.includes(`#### Terraform checks for \`${{ matrix.directory }}\``);
            });


            if (botComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã€æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„å ´åˆã€æ–°è¦ä½œæˆ
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              });
            }

      # Applyã‚¹ãƒ†ãƒƒãƒ—ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é€šå¸¸Planã¨Applyã¯åˆ¥ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚„ã‚¸ãƒ§ãƒ–ã§è¡Œã„ã¾ã™ã€‚
      # Applyã‚’åŒã˜ã‚¸ãƒ§ãƒ–ã§è¡Œã†å ´åˆã¯ã€Planã‚¹ãƒ†ãƒƒãƒ—ã®å¾Œã«æ¡ä»¶ä»˜ãã§è¿½åŠ ã—ã¾ã™ã€‚
      # ä¾‹: ãƒ—ãƒƒã‚·ãƒ¥ã‚¤ãƒ™ãƒ³ãƒˆã‹ã¤ master ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿ Apply
      # - name: Terraform Apply
      #   if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      #   run: terraform apply -auto-approve -input=false


# Apply ã‚¸ãƒ§ãƒ–ã‚’åˆ¥é€”å®šç¾©ã™ã‚‹ä¾‹ (Plan ã‚¸ãƒ§ãƒ–ã¨ã¯åˆ¥ã«ã™ã‚‹æ¨å¥¨æ§‹æˆ)
# Plan ã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãŸå ´åˆã«ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãªã©ã‚‚å¯èƒ½ã§ã™ã€‚
# jobs:
#   terraform-apply:
#     needs: terraform-checks # å¿…è¦ã«å¿œã˜ã¦ plan ã‚¸ãƒ§ãƒ–ã®æˆåŠŸã«ä¾å­˜ã•ã›ã‚‹
#     if: github.event_name == 'push' && github.ref == 'refs/heads/master' # Push to master ã§ãƒˆãƒªã‚¬ãƒ¼
#     runs-on: ubuntu-latest
#     strategy:
#       matrix:
#         directory: ['environments/dev'] # Applyã—ãŸã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
#     defaults:
#       run:
#         working-directory: ${{ matrix.directory }}
#     permissions: # Apply ã«å¿…è¦ãª AWS æ¨©é™ãªã©ã‚’ã“ã“ã§è¨­å®š
#       contents: read
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4
#       - name: Setup Terraform
#         uses: hashicorp/setup-terraform@v3
#       - name: Setup AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ap-northeast-1
#       - name: Terraform Init (Applyç”¨)
#         run: terraform init
#         # State ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®è¨­å®šã‚’ã“ã“ã§ã‚‚æ­£ã—ãè¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
#       - name: Terraform Apply
#         run: terraform apply -auto-approve -input=false