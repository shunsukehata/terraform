name: "Terraform CI/CD Workflow" # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã‚’ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªã‚‚ã®ã«å¤‰æ›´

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, reopened, synchronize] # PRã‚ªãƒ¼ãƒ—ãƒ³ã€å†ã‚ªãƒ¼ãƒ—ãƒ³ã€åŒæœŸï¼ˆæ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆï¼‰ã§ãƒˆãƒªã‚¬ãƒ¼
    branches:
      - master
  issue_comment:
    types: [created] # æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      # AWSèªè¨¼æƒ…å ±ã‚’GitHub Secretsã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ap-northeast-1

    steps:
      # -- ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ --
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ãƒ—ãƒƒã‚·ãƒ¥/PRæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ã‚³ãƒ¡ãƒ³ãƒˆæ™‚ã¯PRã®HEADãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          # fetch-depth: 0 ã¯å·®åˆ†æ¯”è¼ƒã®ãŸã‚ã«å…¨å±¥æ­´ã‚’å–å¾—
          ref: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request.head.ref || github.ref }}
          fetch-depth: 0

      # --- .tf ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œçŸ¥ ---
      # ãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯PRã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹å ´åˆã€dorny/paths-filter ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹å®šã®ãƒ‘ã‚¹/ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
      - name: Check for .tf file changes
        id: check-tf-changes
        uses: dorny/paths-filter@v3 # paths-filter ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
        # ãƒ—ãƒƒã‚·ãƒ¥ ã¾ãŸã¯ PR ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        with:
          filters: |
            tf-changes: # å‡ºåŠ›å¤‰æ•°å
              - '**/*.tf' # ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ä»»æ„ã®å ´æ‰€ã«ã‚ã‚‹ .tf ãƒ•ã‚¡ã‚¤ãƒ«

      # --- ã‚³ãƒ¡ãƒ³ãƒˆãŒ '/terraform plan' ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ ---
      - name: Check Comment Command
        id: check-comment-command
        # issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ
        if: github.event_name == 'issue_comment'
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          IS_PLAN_COMMAND=false
          if [[ "$COMMENT_BODY" == "/terraform plan" ]]; then
            IS_PLAN_COMMAND=true
          fi
          # çµæœã‚’å‡ºåŠ›å¤‰æ•°ã¨ã—ã¦è¨­å®š (steps.check-comment-command.outputs.is_plan_command ã§å‚ç…§)
          echo "is_plan_command=$IS_PLAN_COMMAND" >> "$GITHUB_OUTPUT"
        shell: bash

      # --- Terraformã‚’å®Ÿè¡Œã™ã¹ãã‹æœ€çµ‚åˆ¤æ–­ ---
      # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®å¤‰æ›´ã€PRæ™‚ã®ãƒˆãƒªã‚¬ãƒ¼ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚³ãƒãƒ³ãƒ‰ã®ã„ãšã‚Œã‹ã«è©²å½“ã™ã‚‹ã‹åˆ¤æ–­
      - name: Determine if Terraform Should Run
        id: run-condition
        run: |
          SHOULD_RUN=false
          EVENT_NAME="${{ github.event_name }}"

          if [ "$EVENT_NAME" == "push" ]; then
            # ãƒ—ãƒƒã‚·ãƒ¥æ™‚: check-tf-changes ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›ãŒ 'true' ã®å ´åˆã®ã¿å®Ÿè¡Œ
            if [ "${{ steps.check-tf-changes.outputs.tf-changes }}" == "true" ]; then
              SHOULD_RUN=true
              echo "Trigger: Push with .tf changes"
            else
              echo "Trigger: Push without .tf changes. Skipping Terraform run."
            fi
          elif [ "$EVENT_NAME" == "pull_request" ]; then
             # PRã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚Œã°å¸¸ã«å®Ÿè¡Œ
             # ã‚‚ã—PRæ™‚ã‚‚å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œã—ãŸã„ãªã‚‰ `${{ steps.check-tf-changes.outputs.tf-changes == 'true' }}` ã‚’æ¡ä»¶ã«è¿½åŠ 
            SHOULD_RUN=true
            echo "Trigger: Pull Request"
          elif [ "$EVENT_NAME" == "issue_comment" ]; then
            # check-comment-command ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›ãŒ 'true' ã®å ´åˆã®ã¿å®Ÿè¡Œ
            if [ "${{ steps.check-comment-command.outputs.is_plan_command }}" == "true" ]; then
              SHOULD_RUN=true
              echo "Trigger: '/terraform plan' command in comment"
            else
              echo "Trigger: Comment without command. Skipping Terraform run."
            fi
          fi

          echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
        shell: bash

      # --- Terraformå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ç¾¤ ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        # ç›´å‰ã® Determine ã‚¹ãƒ†ãƒƒãƒ—ã§ run_condition ãŒ 'true' ã®å ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.run-condition.outputs.should_run == 'true'
        with:
          terraform_version: latest

      # Terraform Initã®å®Ÿè¡Œ
      - name: Terraform Init
        id: init
        working-directory: . # TFæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        # SetupãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.setup-terraform.conclusion == 'success'
        run: terraform init -input=false

      # Terraform Validateã®å®Ÿè¡Œ
      - name: Terraform Validate
        id: validate
        working-directory: . # TFæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        if: steps.init.conclusion == 'success'
        run: terraform validate -no-color

      # Terraform Planã®å®Ÿè¡Œ
      - name: Run terraform plan
        id: plan
        working-directory: . # TFæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        if: steps.init.conclusion == 'success'
        run: terraform plan -no-color

      # Planã®çµæœã‚’æ•´å½¢ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯èƒ½ãªdiffå½¢å¼ã«å¤‰æ›
      - name: Reformat Plan
        id: reformat_plan
        if: steps.plan.conclusion == 'success'
        run: |
          # steps.plan.outputs.stdout ã¯ Plan ã®æ¨™æº–å‡ºåŠ›ã€steps.plan.outputs.stderr ã¯ã‚¨ãƒ©ãƒ¼å‡ºåŠ›
          PLAN_OUTPUT="${{ steps.plan.outputs.stdout }}"
          # sed ã‚³ãƒãƒ³ãƒ‰ã§ diff å½¢å¼ã«æ•´å½¢ (è¡Œé ­ã®ã‚¹ãƒšãƒ¼ã‚¹ã¨ +/- ã‚’å…¥ã‚Œæ›¿ãˆã‚‹)
          echo "$PLAN_OUTPUT" | sed -E 's/^([[:space:]]+)([-+])/\2\1/g' > plan.txt
        shell: bash # æ˜ç¤ºçš„ã«bashã‚’ä½¿ç”¨

      # Planã®å†…å®¹ã‚’ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã‚‹
      # æ•´å½¢ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      - name: Put Plan in Env Var
        id: put_plan_env
        if: steps.reformat_plan.conclusion == 'success'
        run: |
          # plan.txt ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿
          PLAN_CONTENT=$(cat plan.txt)
          # GITHUB_ENV ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã—ã¦ç’°å¢ƒå¤‰æ•° PLAN ã‚’è¨­å®š
          # ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå½¢å¼ (EOF) ã‚’ä½¿ç”¨
          echo "PLAN<<EOF" >> "$GITHUB_ENV"
          echo "$PLAN_CONTENT" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"
        shell: bash # æ˜ç¤ºçš„ã«bashã‚’ä½¿ç”¨

      # PRã‚³ãƒ¡ãƒ³ãƒˆã«Planã®çµæœã‚’æŠ•ç¨¿
      # PRã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚Šã€ã‹ã¤Plançµæœã‚’ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã‚‹ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      - name: Read Plan and Post Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && steps.put_plan_env.conclusion == 'success'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |

            // 1. Retrieve existing bot comments for the PR
            const commentIdentifier = ''; // ã‚³ãƒ¡ãƒ³ãƒˆè­˜åˆ¥ã®ãŸã‚ã®éš ã—æ–‡å­—åˆ—
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => {
              // Commented by a bot AND contains our identifier string
              return comment.user.type === 'Bot' && comment.body.includes(commentIdentifier);
            });

            // 2. Prepare format of the comment
            const output = `
              ${commentIdentifier}

              #### Terraform Format Check ğŸ–Œ\`${{ steps.fmt.outcome }}\`
              #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
              #### Terraform Validation ğŸ¤–\`${{ steps.validate.outcome }}\`

              <details><summary>Validation Output</summary>

              \`\`\`terraform
              ${{ steps.validate.outputs.stdout }} // Validate ã®æ¨™æº–å‡ºåŠ›
              \`\`\`

              </details>

              #### Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`

              <details><summary>Show Plan</summary>

              \`\`\`diff
              ${{ env.PLAN }} // ç’°å¢ƒå¤‰æ•°ã«æ ¼ç´ã—ãŸæ•´å½¢æ¸ˆã¿Plançµæœ
              \`\`\`

              </details>

              *Pusher: @${{ github.actor }}, Working Directory: \`${{ matrix.directory || '.' }}\`* // matrix.directory ãŒãªã„å ´åˆã¯ '.' ã‚’è¡¨ç¤º

              `; // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®æœ«å°¾

            // 3. If we have a comment, update it, otherwise create a new one
            if (botComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã€æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„å ´åˆã€æ–°è¦ä½œæˆ
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              });
            }

      # --- â˜…Applyã‚¹ãƒ†ãƒƒãƒ—â˜… ---
      # Applyã¯ master ãƒ–ãƒ©ãƒ³ãƒã¸ã®Pushæ™‚ã®ã¿ã€ã‹ã¤ .tf ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      - name: Terraform Apply
        id: apply
        working-directory: . # TFæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        # Pushã‚¤ãƒ™ãƒ³ãƒˆ AND masterãƒ–ãƒ©ãƒ³ãƒ AND .tfå¤‰æ›´ã‚ã‚Š AND InitæˆåŠŸã®å ´åˆã®ã¿å®Ÿè¡Œ
        if: |
          github.event_name == 'push' &&
          github.ref == 'refs/heads/master' &&
          steps.check-tf-changes.outputs.tf-changes == 'true' && # .tfå¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          steps.init.conclusion == 'success' # InitãŒæˆåŠŸã—ã¦ã„ã‚‹ã‹
        run: terraform apply -auto-approve -input=false
