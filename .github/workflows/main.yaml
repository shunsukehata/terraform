# .github/workflows/main.yaml

name: "Terraform CI/CD Workflow" # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã‚’ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªã‚‚ã®ã«å¤‰æ›´

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
on:
  push:
    branches:
      - master # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§ãƒˆãƒªã‚¬ãƒ¼ (ãƒãƒ¼ã‚¸ã‚’å«ã‚€)
  pull_request:
    types: [opened, reopened, synchronize] # PRã‚ªãƒ¼ãƒ—ãƒ³ã€å†ã‚ªãƒ¼ãƒ—ãƒ³ã€åŒæœŸï¼ˆæ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆï¼‰ã§ãƒˆãƒªã‚¬ãƒ¼
    branches:
      - master # PRã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒãŒmasterã®å ´åˆ
    # paths: # pathsãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ãƒˆãƒªã‚¬ãƒ¼ãƒ¬ãƒ™ãƒ«ã§ã‚‚å¯èƒ½ã§ã™ãŒã€å¾Œè¿°ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ˆã‚ŠæŸ”è»Ÿã«æ‰±ã„ã¾ã™
    #   - "**/*.tf"
  issue_comment: # â˜…è¿½åŠ â˜… ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚¤ãƒ™ãƒ³ãƒˆã§ãƒˆãƒªã‚¬ãƒ¼
    types: [created] # æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼

# ã‚¸ãƒ§ãƒ–ãŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸­ã«æŒã¤æ¨©é™ã‚’è¨­å®š
# comments: write ã¯PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
# contents: read ã¯ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
# pull-requests: write ã¯PRã®çŠ¶æ…‹ï¼ˆãƒãƒ¼ã‚¸å¯èƒ½æ€§ãªã©ï¼‰ã‚’èª­ã¿å–ã‚‹ãŸã‚ã«å¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
# issues: write ã¯ã‚³ãƒ¡ãƒ³ãƒˆã«é–¢é€£ã™ã‚‹å ´åˆï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã®ç·¨é›†/å‰Šé™¤ãªã©ï¼‰ã«å¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
permissions:
  contents: read
  pull-requests: write
  issues: write # ã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ã®å ´åˆã«æ¨å¥¨

jobs:
  terraform: # ã‚¸ãƒ§ãƒ–åã‚’ã‚ˆã‚Šä¸€èˆ¬çš„ãªã‚‚ã®ã«å¤‰æ›´
    runs-on: ubuntu-latest # å®Ÿè¡Œç’°å¢ƒã¨ã—ã¦Ubuntuã®æœ€æ–°ç‰ˆã‚’ä½¿ç”¨

    env:
      # AWSèªè¨¼æƒ…å ±ã‚’GitHub Secretsã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
      # ã“ã‚Œã‚‰ã®Secretsã¯ãƒªãƒã‚¸ãƒˆãƒªã®è¨­å®šã§äº‹å‰ã«ç™»éŒ²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
      # ã“ã®èªè¨¼æƒ…å ±ã«ã¯ã€Terraformå®Ÿè¡Œã«å¿…è¦ãªAWSãƒªã‚½ãƒ¼ã‚¹ã¸ã®æ¨©é™ã¨ã€
      # Remote State (S3+DynamoDBãªã©) ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} # â˜…ä¿®æ­£â˜… secrets.secrets ã‚’ secrets ã«ä¿®æ­£
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # â˜…ä¿®æ­£â˜… secrets.secrets ã‚’ secrets ã«ä¿®æ­£
      AWS_REGION: ap-northeast-1 # ä½¿ç”¨ã™ã‚‹AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š (ä¾‹: æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³)

    steps:
      # -- ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ --
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ©ãƒ³ãƒŠãƒ¼ç’°å¢ƒã«ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ãƒ—ãƒƒã‚·ãƒ¥/PRæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ã‚³ãƒ¡ãƒ³ãƒˆæ™‚ã¯PRã®HEADãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          # fetch-depth: 0 ã¯å·®åˆ†æ¯”è¼ƒã®ãŸã‚ã«å…¨å±¥æ­´ã‚’å–å¾—ã—ã¾ã™ã€‚
          ref: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request.head.ref || github.ref }}
          fetch-depth: 0

      # --- .tf ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œçŸ¥ ---
      # ãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯PRã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹å ´åˆã€dorny/paths-filter ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹å®šã®ãƒ‘ã‚¹/ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
      - name: Check for .tf file changes
        id: check-tf-changes # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§çµæœã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        uses: dorny/paths-filter@v3 # paths-filter ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
        # â˜…æ¡ä»¶â˜… ãƒ—ãƒƒã‚·ãƒ¥ ã¾ãŸã¯ PR ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
        # issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã§ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ¤œçŸ¥ã¯ä¸è¦ã§ã€ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã®ãƒã‚§ãƒƒã‚¯ã‚’å„ªå…ˆã—ã¾ã™ã€‚
        if: (github.event_name == 'push' || github.event_name == 'pull_request') # â˜…ä¿®æ­£â˜… ifæ¡ä»¶ã«ã‚«ãƒƒã‚³ã‚’è¿½åŠ 
        with:
          # å¤‰æ›´ã‚’æ¤œçŸ¥ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚
          # tf-changes ã¨ã„ã†åå‰ã§å‡ºåŠ›ã•ã‚Œã€å¤‰æ›´ãŒã‚ã‚Œã° 'true'ã€ãªã‘ã‚Œã° 'false' ã«ãªã‚Šã¾ã™ã€‚
          filters: |
            tf-changes: # å‡ºåŠ›å¤‰æ•°å (steps.check-tf-changes.outputs.tf-changes ã§å‚ç…§)
              - '**/*.tf' # ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ä»»æ„ã®å ´æ‰€ã«ã‚ã‚‹ .tf ãƒ•ã‚¡ã‚¤ãƒ«

      # --- ã‚³ãƒ¡ãƒ³ãƒˆãŒ '/terraform plan' ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ ---
      # issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿å®Ÿè¡Œã•ã‚Œã€ã‚³ãƒ¡ãƒ³ãƒˆãŒæŒ‡å®šã‚³ãƒãƒ³ãƒ‰ã‹åˆ¤æ–­ã—ã¾ã™ã€‚
      - name: Check Comment Command
        id: check-comment-command # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§çµæœã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        # â˜…æ¡ä»¶â˜… issue_comment ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã®ã¿ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
        if: github.event_name == 'issue_comment'
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          IS_PLAN_COMMAND=false
          if [[ "$COMMENT_BODY" == "/terraform plan" ]]; then
            IS_PLAN_COMMAND=true
          fi
          # çµæœã‚’å‡ºåŠ›å¤‰æ•°ã¨ã—ã¦è¨­å®šã—ã¾ã™ (steps.check-comment-command.outputs.is_plan_command ã§å‚ç…§)
          echo "is_plan_command=$IS_PLAN_COMMAND" >> "$GITHUB_OUTPUT"
        shell: bash # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã«bashã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ˜ç¤º

      # --- Terraformã‚’å®Ÿè¡Œã™ã¹ãã‹æœ€çµ‚åˆ¤æ–­ ---
      # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®å¤‰æ›´ã€PRæ™‚ã®ãƒˆãƒªã‚¬ãƒ¼ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚³ãƒãƒ³ãƒ‰ã®ã„ãšã‚Œã‹ã«è©²å½“ã™ã‚‹ã‹åˆ¤æ–­ã—ã¾ã™ã€‚
      - name: Determine if Terraform Should Run # ã‚¹ãƒ†ãƒƒãƒ—ã®åå‰
        id: run-condition # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§çµæœã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        # â˜…â˜…â˜… ã“ã“ãŒæœ€ã‚‚é‡è¦ â˜…â˜…â˜…
        # run: | ãŒæ­£ã—ãè¨˜è¿°ã•ã‚Œã€ãã®å¾Œã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ãŒæ­£ã—ãã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        run: |
          # ä»¥é™ã®ã™ã¹ã¦ã®è¡Œã¯ã€run: | ã‚ˆã‚Šã‚‚æ·±ãã€åŒã˜ãƒ¬ãƒ™ãƒ«ã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã—ã¾ã™ã€‚
          SHOULD_RUN=false # åˆæœŸå€¤ã¨ã—ã¦ã€Terraformã¯å®Ÿè¡Œã—ãªã„ã¨è¨­å®š
          EVENT_NAME="${{ github.event_name }}" # ã‚¤ãƒ™ãƒ³ãƒˆåã‚’ã‚¯ã‚©ãƒ¼ãƒˆã—ã¦å–å¾—

          # Debug: GITHUB_OUTPUT path
          echo "DEBUG: GITHUB_OUTPUT path = '$GITHUB_OUTPUT'"

          if [ "$EVENT_NAME" == "push" ]; then
            echo "Event: push"
            BASE_SHA=$(git merge-base origin/${{ github.base_ref }} ${{ github.sha }})
            HEAD_SHA="${{ github.sha }}"
            echo "Comparing changes between $BASE_SHA and $HEAD_SHA across the repository for *.tf files."
            if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "\.tf$"; then
              echo "Detected .tf file changes anywhere in the repository on push."
              SHOULD_RUN=true
            else
              echo "No .tf file changes detected anywhere in the repository on push. Skipping Terraform run."
            fi

          elif [ "$EVENT_NAME" == "pull_request" ]; then
            echo "Event: pull_request"
            echo "Trigger: Pull Request event." # ãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            SHOULD_RUN=true # SHOULD_RUN ãŒ true ã«è¨­å®šã•ã‚Œã‚‹ã¯ãš

          elif [ "$EVENT_NAME" == "issue_comment" ]; then
            echo "Event: issue_comment"
            COMMENT_BODY="${{ github.event.comment.body }}"
            echo "Comment: \"$COMMENT_BODY\""
            if [[ "$COMMENT_BODY" == "/terraform plan" ]]; then
              echo "Detected '/terraform plan' command."
              SHOULD_RUN=true
            else
              echo "Command is not '/terraform plan'. Skipping Terraform run."
            fi
          fi # if/elif/else æ§‹é€ ã®çµ‚ã‚ã‚Š

          # --- â˜…é‡è¦ãªå‡ºåŠ›è¡ŒãŸã¡â˜… ---
          # ã“ã‚Œã‚‰ã®è¡Œã¯ã€ä¸Šè¨˜ã®if/elif/elseæ§‹é€ ãŒçµ‚äº†ã—ãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
          # 'fi' ã¨åŒã˜ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          # â˜…ãƒ‡ãƒãƒƒã‚°â˜… å‡ºåŠ›è¡Œã®ç›´å‰ã§SHOULD_RUNã®å€¤ã‚’ç¢ºèª
          echo "DEBUG: Value of SHOULD_RUN before outputting: $SHOULD_RUN"

          # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§å‚ç…§ã§ãã‚‹ã‚ˆã†æœ€çµ‚åˆ¤æ–­ã‚’å‡ºåŠ›
          # â˜…â˜…â˜…ã“ã®è¡ŒãŒGitHub Actionsã«æ•æ‰ã•ã‚Œã‚‹ã‹ã€ã¾ã å•é¡Œã®å¯èƒ½æ€§ã‚ã‚Šâ˜…â˜…â˜…
          # ã“ã®è¡Œã®å®Ÿè¡Œç—•è·¡ãŒãƒ­ã‚°ã«è¦‹ãˆã‚‹ã‹ã€å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ãŒã“ã‚Œã‚’èªè­˜ã§ãã‚‹ã‹ãŒéµ
          echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"

          # â˜…ãƒ‡ãƒãƒƒã‚°â˜… å‡ºåŠ›è¨­å®šç›´å¾Œã®ç¢ºèª
          # ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã‚Œã°ã€ç›´å‰ã®echo >> $GITHUB_OUTPUT ã‚³ãƒãƒ³ãƒ‰è‡ªä½“ã¯ã‚·ã‚§ãƒ«ã«å®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚
          echo "DEBUG: Output setting command executed."

          # â˜…ãƒ‡ãƒãƒƒã‚°â˜… GITHUB_OUTPUT ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’èª­ã¿ä¸Šã’ã¦è¡¨ç¤º
          # ã“ã‚ŒãŒãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã‚Œã°ã€ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æ›¸ãè¾¼ã¿è‡ªä½“ã¯æˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
          # cat ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸç—•è·¡ã¨ã€ãã®å‡ºåŠ›ã®ä¸¡æ–¹ã‚’ç¢ºèªã—ã¾ã™ã€‚
          echo "DEBUG: Content of $GITHUB_OUTPUT after write:"
          cat "$GITHUB_OUTPUT"
          echo "DEBUG: --- End of $GITHUB_OUTPUT content ---"

          echo "DEBUG: Determine step script finished."

        # â˜…â˜…â˜…ã“ã“ã‚‚é‡è¦â˜…â˜…â˜…
        # shell: bash ãŒ run: | ã¨åŒã˜ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã§æ­£ã—ãè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
        shell: bash

      # --- Terraformå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ç¾¤ ---
      # ã“ã‚Œã‚‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ç›´å‰ã® Determine ã‚¹ãƒ†ãƒƒãƒ—ã§ Terraform ã‚’å®Ÿè¡Œã™ã‚‹ã¨åˆ¤æ–­ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œã—ã¾ã™ã€‚

      # Terraformã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        # â˜…è¿½åŠ â˜… ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶šè¡Œã™ã‚‹
        continue-on-error: true
        with:
          terraform_version: 1.7.5 # â˜…ä¿®æ­£â˜… ã“ã“ã‚’ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å›ºå®š

      # Terraform Initã®å®Ÿè¡Œ
      - name: Terraform Init
        id: init # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§çµæœã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        # â˜…è¨­å®šâ˜… TFæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š (ä¾‹: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã®å ´åˆ '.')
        working-directory: .
        # â˜…æ¡ä»¶â˜… SetupãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.setup-terraform.conclusion == 'success'
        run: terraform init -input=false # CIç’°å¢ƒã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’æ±‚ã‚ãªã„

      # Terraform Validateã®å®Ÿè¡Œ
      - name: Terraform Validate
        id: validate # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§çµæœã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        working-directory: . # â˜…è¨­å®šâ˜… TFæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        # â˜…æ¡ä»¶â˜… InitãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.init.conclusion == 'success'
        run: terraform validate -no-color # ã‚«ãƒ©ãƒ¼å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–

      # Terraform Planã®å®Ÿè¡Œ
      - name: Run terraform plan
        id: plan # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§çµæœã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        working-directory: . # â˜…è¨­å®šâ˜… TFæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        # â˜…æ¡ä»¶â˜… InitãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.init.conclusion == 'success'
        run: terraform plan -no-color # ã‚«ãƒ©ãƒ¼å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–

      # Planã®çµæœã‚’æ•´å½¢ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯èƒ½ãªdiffå½¢å¼ã«å¤‰æ›
      # PlanãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œã—ã¾ã™ã€‚
      - name: Reformat Plan
        id: reformat_plan # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§çµæœã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        # â˜…æ¡ä»¶â˜… PlanãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.plan.conclusion == 'success'
        run: |
          # steps.plan.outputs.stdout ã¯ Plan ã®æ¨™æº–å‡ºåŠ›ã€steps.plan.outputs.stderr ã¯ã‚¨ãƒ©ãƒ¼å‡ºåŠ›
          # PlanãŒæˆåŠŸã—ãŸå ´åˆ(conclusion == 'success')ã¯stdoutã«è¨ˆç”»ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
          # sed ã‚³ãƒãƒ³ãƒ‰ã§ diff å½¢å¼ã«æ•´å½¢ (è¡Œé ­ã®ã‚¹ãƒšãƒ¼ã‚¹ã¨ +/- ã‚’å…¥ã‚Œæ›¿ãˆã‚‹)
          # sed ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã—ãŸå ´åˆã‚’è€ƒæ…®ã—ã¦ || true ã‚’è¿½åŠ 
          PLAN_OUTPUT="${{ steps.plan.outputs.stdout }}"
          echo "$PLAN_OUTPUT" | sed -E 's/^([[:space:]]+)([-+])/\2\1/g' > plan.txt || true
        shell: bash # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã«bashã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ˜ç¤º

      # æ•´å½¢ã—ãŸPlanã®å†…å®¹ã‚’ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã‚‹
      # æ•´å½¢ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œã—ã¾ã™ã€‚
      - name: Put Plan in Env Var
        id: put_plan_env # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§çµæœã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        # â˜…æ¡ä»¶â˜… æ•´å½¢ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: steps.reformat_plan.conclusion == 'success'
        run: |
          # plan.txt ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿èª­ã¿è¾¼ã¿
          if [ -f plan.txt ]; then
            PLAN_CONTENT=$(cat plan.txt)
            # GITHUB_ENV ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã—ã¦ç’°å¢ƒå¤‰æ•° PLAN ã‚’è¨­å®šã—ã¾ã™ã€‚
            # ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå½¢å¼ (EOF) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
            echo "PLAN<<EOF" >> "$GITHUB_ENV"
            echo "$PLAN_CONTENT" >> "$GITHUB_ENV"
            echo "EOF" >> "$GITHUB_ENV"
          else
            echo "Plan output file plan.txt not found."
          fi
        shell: bash # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã«bashã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ˜ç¤º

      # PRã‚³ãƒ¡ãƒ³ãƒˆã«Planã®çµæœã‚’æŠ•ç¨¿
      # PRã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚Šã€ã‹ã¤Plançµæœã‚’ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã‚‹ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œã—ã¾ã™ã€‚
      - name: Read Plan and Post Comment
        uses: actions/github-script@v7 # GitHub APIã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        # â˜…æ¡ä»¶â˜… Pull Request ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚Šã€ã‹ã¤ Plançµæœã‚’ç’°å¢ƒå¤‰æ•°ã«æ ¼ç´ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
        if: github.event_name == 'pull_request' && steps.put_plan_env.conclusion == 'success'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }} # GitHubæä¾›ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨
          script: |
            const commentIdentifier = '';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes(commentIdentifier);
            });

            const output = `
              ${commentIdentifier}

              #### Terraform Format Check ğŸ–Œ\`${{ steps.fmt.outcome }}\`
              #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
              #### Terraform Validation ğŸ¤–\`${{ steps.validate.outcome }}\`

              <details><summary>Validation Output</summary>

              \`\`\`terraform
              ${{ steps.validate.outputs.stdout }} // Validate ã®æ¨™æº–å‡ºåŠ›
              \`\`\`

              </details>

              #### Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`

              <details><summary>Show Plan</summary>

              \`\`\`diff
              ${{ env.PLAN }} // ç’°å¢ƒå¤‰æ•°ã«æ ¼ç´ã—ãŸæ•´å½¢æ¸ˆã¿Plançµæœ
              \`\`\`

              </details>

              *Pusher: @${{ github.actor }}, Working Directory: \`${{ matrix.directory || '.' }}\`* // matrix.directory ãŒãªã„å ´åˆã¯ '.' ã‚’è¡¨ç¤º

              `; // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®æœ«å°¾

            // 3. If we have a comment, update it, otherwise create a new one
            if (botComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã€æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„å ´åˆã€æ–°è¦ä½œæˆ
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: output
              });
            }

      # --- â˜…Applyã‚¹ãƒ†ãƒƒãƒ—â˜… ---
      # Applyã¯ master ãƒ–ãƒ©ãƒ³ãƒã¸ã®Pushæ™‚ã®ã¿ã€ã‹ã¤ .tf ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œã—ã¾ã™ã€‚
      - name: Terraform Apply
        id: apply # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§çµæœã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®ID
        working-directory: . # â˜…è¨­å®šâ˜… TFæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£)
        # â˜…æ¡ä»¶â˜… Pushã‚¤ãƒ™ãƒ³ãƒˆ AND masterãƒ–ãƒ©ãƒ³ãƒ AND .tfå¤‰æ›´ã‚ã‚Š AND InitæˆåŠŸã®å ´åˆã®ã¿å®Ÿè¡Œ
        # .tfå¤‰æ›´ã®æœ‰ç„¡ã¯ check-tf-changes ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›ã§åˆ¤æ–­ã—ã¾ã™ã€‚
        if: |
          github.event_name == 'push' &&
          github.ref == 'refs/heads/master' &&
          steps.check-tf-changes.outputs.tf-changes == 'true' &&
          steps.init.conclusion == 'success'

        run: terraform apply -auto-approve -input=false # -auto-approve ã¯ç¢ºèªãªã—ã«å®Ÿè¡Œã€‚æœ¬ç•ªç’°å¢ƒã§ã¯æ…é‡ã«ã€‚